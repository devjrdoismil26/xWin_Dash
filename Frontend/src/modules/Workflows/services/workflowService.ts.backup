import { apiClient } from '@/services';
import {
  Workflow,
  WorkflowExecution,
  WorkflowStep,
  WorkflowTrigger,
  WorkflowCanvasData,
  WorkflowAnalytics,
  WorkflowTemplate,
  WorkflowVariable,
  WorkflowStatus,
  WorkflowTriggerType,
  WorkflowCondition,
  WorkflowOperator,
  WorkflowSchedule,
  WorkflowStepType,
  WorkflowStepConfig,
  WorkflowExecutionStatus,
  WorkflowCanvasNode,
  WorkflowCanvasEdge,
  WorkflowValidationResult,
  WorkflowPerformanceMetrics,
  WorkflowSystemMetrics
} from '../types/workflowTypes';
  successful_executions: number;
  failed_executions: number;
  average_execution_time: number;
  last_execution_at?: string;
}

export interface WorkflowTemplate {
  id: string;
  name: string;
  description: string;
  category: string;
  definition: WorkflowDefinition;
  created_at: string;
}

export interface WorkflowData {
  id: string;
  [key: string]: any;
}

export interface WorkflowResponse {
  success: boolean;
  data?: WorkflowData | WorkflowData[];
  message?: string;
  error?: string;
}

class WorkflowService {
  private api = apiClient;

  // ===== WORKFLOW CRUD OPERATIONS =====
  async getWorkflows(params: any = {}): Promise<WorkflowResponse> {
    try {
      const response = await this.api.get('/workflows', { params });
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to fetch workflows'
      };
    }
  }

  async getWorkflow(workflowId: string): Promise<WorkflowResponse> {
    try {
      const response = await this.api.get(`/workflows/${workflowId}`);
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to fetch workflow'
      };
    }
  }

  async createWorkflow(workflowData: any): Promise<WorkflowResponse> {
    try {
      const response = await this.api.post('/workflows', workflowData);
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to create workflow'
      };
    }
  }

  async updateWorkflow(workflowId: string, workflowData: any): Promise<WorkflowResponse> {
    try {
      const response = await this.api.put(`/workflows/${workflowId}`, workflowData);
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to update workflow'
      };
    }
  }

  async deleteWorkflow(workflowId: string): Promise<WorkflowResponse> {
    try {
      const response = await this.api.delete(`/workflows/${workflowId}`);
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to delete workflow'
      };
    }
  }

  // ===== WORKFLOW EXECUTION =====
  async executeWorkflow(workflowId: string, executionData: any = {}): Promise<WorkflowResponse> {
    try {
      const response = await this.api.post(`/workflows/${workflowId}/execute`, executionData);
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to execute workflow'
      };
    }
  }

  async simulateWorkflow(workflowId: string, simulationData: any = {}): Promise<WorkflowResponse> {
    try {
      const response = await this.api.post(`/workflows/${workflowId}/simulate`, simulationData);
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to simulate workflow'
      };
    }
  }

  async cloneWorkflow(workflowId: string, cloneData: any = {}): Promise<WorkflowResponse> {
    try {
      const response = await this.api.post(`/workflows/${workflowId}/clone`, cloneData);
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to clone workflow'
      };
    }
  }

  async toggleWorkflowActive(workflowId: string): Promise<WorkflowResponse> {
    try {
      const response = await this.api.patch(`/workflows/${workflowId}/toggle-active`);
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to toggle workflow status'
      };
    }
  }

  // ===== WORKFLOW CANVAS & DEFINITION =====
  async saveWorkflowDefinition(workflowId: string, definition: any): Promise<WorkflowResponse> {
    try {
      const response = await this.api.post(`/workflows/${workflowId}/definition`, definition);
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to save workflow definition'
      };
    }
  }

  async getWorkflowDefinition(workflowId: string): Promise<WorkflowResponse> {
    try {
      const response = await this.api.get(`/workflows/${workflowId}/definition`);
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to fetch workflow definition'
      };
    }
  }

  // ===== WORKFLOW EXECUTIONS =====
  async getWorkflowExecutions(workflowId: string, params: any = {}): Promise<WorkflowResponse> {
    try {
      const response = await this.api.get(`/workflows/${workflowId}/executions`, { params });
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to fetch workflow executions'
      };
    }
  }

  async pauseExecution(executionId: string): Promise<WorkflowResponse> {
    try {
      const response = await this.api.post(`/workflows/executions/${executionId}/pause`);
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to pause execution'
      };
    }
  }

  async resumeExecution(executionId: string): Promise<WorkflowResponse> {
    try {
      const response = await this.api.post(`/workflows/executions/${executionId}/resume`);
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to resume execution'
      };
    }
  }

  async cancelExecution(executionId: string): Promise<WorkflowResponse> {
    try {
      const response = await this.api.post(`/workflows/executions/${executionId}/cancel`);
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to cancel execution'
      };
    }
  }

  // ===== WORKFLOW VALIDATION =====
  async validateWorkflow(workflowId: string, definition: any = null): Promise<WorkflowResponse> {
    try {
      const payload = definition ? { definition } : {};
      const response = await this.api.post(`/workflows/${workflowId}/validate`, payload);
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to validate workflow'
      };
    }
  }

  // ===== WORKFLOW METRICS & ANALYTICS =====
  async getWorkflowMetrics(workflowId: string, params: any = {}): Promise<WorkflowResponse> {
    try {
      const response = await this.api.get(`/workflows/${workflowId}/metrics`, { params });
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to fetch workflow metrics'
      };
    }
  }

  async getGeneralMetrics(params: any = {}): Promise<WorkflowResponse> {
    try {
      const response = await this.api.get('/workflows/metrics', { params });
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to fetch general metrics'
      };
    }
  }

  async getSystemPerformanceMetrics(params: any = {}): Promise<WorkflowResponse> {
    try {
      const response = await this.api.get('/workflows/system/performance', { params });
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to fetch system performance metrics'
      };
    }
  }

  // ===== DRAG & DROP CANVAS OPERATIONS =====
  async getAvailableNodes(): Promise<WorkflowResponse> {
    try {
      const response = await this.api.get('/workflows/canvas/nodes');
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to fetch available nodes'
      };
    }
  }

  async validateWorkflowDefinition(definition: any): Promise<WorkflowResponse> {
    try {
      const response = await this.api.post('/workflows/canvas/validate', { definition });
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to validate workflow definition'
      };
    }
  }

  async saveWorkflowFromCanvas(workflowData: any): Promise<WorkflowResponse> {
    try {
      const response = await this.api.post('/workflows/canvas/save', workflowData);
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to save workflow from canvas'
      };
    }
  }

  async updateWorkflowFromCanvas(workflowId: string, workflowData: any): Promise<WorkflowResponse> {
    try {
      const response = await this.api.put(`/workflows/canvas/${workflowId}`, workflowData);
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to update workflow from canvas'
      };
    }
  }

  async duplicateWorkflow(workflowId: string, duplicateData: any = {}): Promise<WorkflowResponse> {
    try {
      const response = await this.api.post(`/workflows/canvas/${workflowId}/duplicate`, duplicateData);
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to duplicate workflow'
      };
    }
  }

  async getWorkflowTemplates(): Promise<WorkflowResponse> {
    try {
      const response = await this.api.get('/workflows/canvas/templates');
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to fetch workflow templates'
      };
    }
  }

  async createFromTemplate(templateId: string, templateData: any = {}): Promise<WorkflowResponse> {
    try {
      const response = await this.api.post('/workflows/canvas/templates/create', {
        template_id: templateId,
        ...templateData
      });
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to create workflow from template'
      };
    }
  }

  async getDragDropStatistics(): Promise<WorkflowResponse> {
    try {
      const response = await this.api.get('/workflows/canvas/statistics');
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to fetch drag & drop statistics'
      };
    }
  }

  // ===== CANVAS LAYOUT & OPTIMIZATION =====
  async autoOrganizeCanvas(workflowId: string): Promise<WorkflowResponse> {
    try {
      const response = await this.api.post(`/workflows/canvas/${workflowId}/auto-organize`);
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to auto-organize canvas'
      };
    }
  }

  async alignCanvasNodes(workflowId: string, alignmentData: any): Promise<WorkflowResponse> {
    try {
      const response = await this.api.post(`/workflows/canvas/${workflowId}/align`, alignmentData);
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to align canvas nodes'
      };
    }
  }

  async optimizeCanvasLayout(workflowId: string, optimizationData: any = {}): Promise<WorkflowResponse> {
    try {
      const response = await this.api.post(`/workflows/canvas/${workflowId}/optimize`, optimizationData);
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to optimize canvas layout'
      };
    }
  }

  async analyzeCanvas(workflowId: string): Promise<WorkflowResponse> {
    try {
      const response = await this.api.get(`/workflows/canvas/${workflowId}/analyze`);
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to analyze canvas'
      };
    }
  }

  async exportCanvasConfig(workflowId: string, exportOptions: any = {}): Promise<WorkflowResponse> {
    try {
      const response = await this.api.post(`/workflows/canvas/${workflowId}/export`, exportOptions);
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to export canvas config'
      };
    }
  }

  // ===== ORCHESTRATION & ENTERPRISE =====
  async orchestrateWorkflows(orchestrationData: any): Promise<WorkflowResponse> {
    try {
      const response = await this.api.post('/workflows/orchestrate', orchestrationData);
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to orchestrate workflows'
      };
    }
  }

  async exportWorkflows(exportOptions: any = {}): Promise<WorkflowResponse> {
    try {
      const response = await this.api.post('/workflows/export', exportOptions);
      return {
        success: true,
        data: response.data
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.response?.data?.message || 'Failed to export workflows'
      };
    }
  }

  // ===== UTILITY METHODS =====
  getWorkflowStatusOptions(): Array<{ value: string; label: string; color: string }> {
    return [
      { value: 'draft', label: 'Draft', color: 'gray' },
      { value: 'active', label: 'Active', color: 'green' },
      { value: 'paused', label: 'Paused', color: 'yellow' },
      { value: 'archived', label: 'Archived', color: 'red' }
    ];
  }

  getExecutionStatusOptions(): Array<{ value: string; label: string; color: string }> {
    return [
      { value: 'pending', label: 'Pending', color: 'blue' },
      { value: 'running', label: 'Running', color: 'green' },
      { value: 'completed', label: 'Completed', color: 'green' },
      { value: 'failed', label: 'Failed', color: 'red' },
      { value: 'cancelled', label: 'Cancelled', color: 'gray' },
      { value: 'paused', label: 'Paused', color: 'yellow' }
    ];
  }

  formatWorkflowForDisplay(workflow: any): any {
    return {
      ...workflow,
      status_label: this.getWorkflowStatusOptions().find(s => s.value === workflow.status)?.label || workflow.status,
      created_at_formatted: new Date(workflow.created_at).toLocaleDateString(),
      updated_at_formatted: new Date(workflow.updated_at).toLocaleDateString()
    };
  }

  formatExecutionForDisplay(execution: any): any {
    return {
      ...execution,
      status_label: this.getExecutionStatusOptions().find(s => s.value === execution.status)?.label || execution.status,
      started_at_formatted: execution.started_at ? new Date(execution.started_at).toLocaleString() : 'Not started',
      completed_at_formatted: execution.completed_at ? new Date(execution.completed_at).toLocaleString() : 'Not completed'
    };
  }
}

export default new WorkflowService();